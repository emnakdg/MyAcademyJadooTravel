@using JadooTravel.Dtos.BookingDtos
@using JadooTravel.Dtos.DestinationDtos
@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/AdminLayout/Layout.cshtml";
    var latestBookings = ViewBag.LatestBookings as List<ResultBookingDto> ?? new List<ResultBookingDto>();
    var latestTours = ViewBag.LatestTours as List<ResultDestinationDto> ?? new List<ResultDestinationDto>();
    var tourNames = ViewBag.TourNames as List<string> ?? new List<string>();
    var tourCounts = ViewBag.TourCounts as List<int> ?? new List<int>();
    var monthlyLabels = ViewBag.MonthlyLabels as List<string> ?? new List<string>();
    var monthlyCounts = ViewBag.MonthlyCounts as List<int> ?? new List<int>();
    var statusLabels = ViewBag.StatusLabels as List<string> ?? new List<string>();
    var statusCounts = ViewBag.StatusCounts as List<int> ?? new List<int>();
}

<div class="body-wrapper">
    <div class="body-wrapper-inner">
        <div class="container-fluid">
            <!--  Header Start -->
            <header class="app-header">
                <nav class="navbar navbar-expand-lg navbar-light">
                    <ul class="navbar-nav">
                        <li class="nav-item d-block d-xl-none">
                            <a class="nav-link sidebartoggler " id="headerCollapse" href="javascript:void(0)">
                                <i class="ti ti-menu-2"></i>
                            </a>
                        </li>
                    </ul>
                    <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
                        <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
                            <li class="nav-item dropdown">
                                <a class="nav-link " href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown" aria-expanded="false">
                                    <img src="/public/assets/img/testimonial/author.png" alt="" width="35" height="35" class="rounded-circle">
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </header>
            <!--  Header End -->

            <!--  Charts Row -->
            <div class="row">
                <!-- Tour Booking Chart -->
                <div class="col-lg-4 d-flex align-items-stretch">
                    <div class="card w-100">
                        <div class="card-body">
                            <h5 class="card-title fw-semibold mb-4">Tur Rezervasyonları</h5>
                            <div id="tourBookingChart"></div>
                        </div>
                    </div>
                </div>
                <!-- Monthly Bookings Chart -->
                <div class="col-lg-4 d-flex align-items-stretch">
                    <div class="card w-100">
                        <div class="card-body">
                            <h5 class="card-title fw-semibold mb-4">Aylık Rezervasyonlar</h5>
                            <div id="monthlyChart"></div>
                        </div>
                    </div>
                </div>
                <!-- Status Distribution Chart -->
                <div class="col-lg-4 d-flex align-items-stretch">
                    <div class="card w-100">
                        <div class="card-body">
                            <h5 class="card-title fw-semibold mb-4">Rezervasyon Durumları</h5>
                            <div id="statusChart"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Latest Reservations - Full Width (12 columns) -->
            <div class="row">
                <div class="col-12">
                    <div class="card w-100">
                        <div class="card-body p-4">
                            <div class="d-flex mb-4 justify-content-between align-items-center">
                                <h5 class="mb-0 fw-bold">Son 5 Rezervasyon</h5>
                                <a href="/Booking/BookingList" class="btn btn-primary btn-sm">Tümünü Gör</a>
                            </div>
                            <div class="table-responsive" data-simplebar>
                                <table class="table table-borderless align-middle text-nowrap">
                                    <thead>
                                        <tr>
                                            <th scope="col">Müşteri</th>
                                            <th scope="col">Tur</th>
                                            <th scope="col">Tarih</th>
                                            <th scope="col">Kişi</th>
                                            <th scope="col">Toplam</th>
                                            <th scope="col">Durum</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (latestBookings.Any())
                                        {
                                            @foreach (var booking in latestBookings)
                                            {
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="me-3">
                                                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                                                                    @booking.FullName?.Substring(0, 1).ToUpper()
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-1 fw-bolder">@booking.FullName</h6>
                                                                <p class="fs-3 mb-0">@booking.Email</p>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <p class="fs-3 fw-normal mb-0">@booking.DestinationName</p>
                                                    </td>
                                                    <td>
                                                        <p class="fs-3 fw-normal mb-0">@booking.BookingDate.ToString("dd.MM.yyyy")</p>
                                                    </td>
                                                    <td>
                                                        <p class="fs-3 fw-normal mb-0">@booking.NumberOfPeople kişi</p>
                                                    </td>
                                                    <td>
                                                        <p class="fs-3 fw-normal mb-0 text-success">@booking.TotalPrice.ToString("N0") ₺</p>
                                                    </td>
                                                    <td>
                                                        @if (booking.Status == "Confirmed")
                                                        {
                                                            <span class="badge bg-light-success rounded-pill text-success px-3 py-2 fs-3">Onaylandı</span>
                                                        }
                                                        else if (booking.Status == "Cancelled")
                                                        {
                                                            <span class="badge bg-light-danger rounded-pill text-danger px-3 py-2 fs-3">İptal</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-light-warning rounded-pill text-warning px-3 py-2 fs-3">Beklemede</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">Henüz rezervasyon bulunmuyor</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Latest 4 Tours -->
            <div class="row">
                <div class="col-12">
                    <h5 class="fw-semibold mb-4">Son Eklenen Turlar</h5>
                </div>
                @if (latestTours.Any())
                {
                    @foreach (var tour in latestTours)
                    {
                        <div class="col-sm-6 col-xl-3">
                            <div class="card overflow-hidden">
                                <div class="position-relative">
                                    <a href="javascript:void(0)">
                                        <img src="@tour.ImageUrl" class="card-img-top rounded-0" alt="@tour.CityCountry" style="height: 180px; object-fit: cover;">
                                    </a>
                                    <a href="/Destination/UpdateDestination/@tour.DestinationId"
                                       class="bg-primary rounded-circle p-2 text-white d-inline-flex position-absolute bottom-0 end-0 mb-n3 me-3">
                                        <i class="ti ti-edit fs-4"></i>
                                    </a>
                                </div>
                                <div class="card-body pt-3 p-4">
                                    <h6 class="fw-semibold fs-4">@tour.CityCountry</h6>
                                    <div class="d-flex align-items-center justify-content-between">
                                        <h6 class="fw-semibold fs-4 mb-0">
                                            @tour.Price.ToString("N0") ₺
                                        </h6>
                                        <span class="badge bg-light-primary text-primary">@tour.DayNight</span>
                                    </div>
                                    <p class="text-muted fs-3 mt-2 mb-0">Kapasite: @tour.Capacity kişi</p>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12">
                        <div class="alert alert-info">Henüz tur bulunmuyor</div>
                    </div>
                }
            </div>

            <div class="py-6 px-6 text-center">
                <p class="mb-0 fs-4">JadooTravel Admin Panel</p>
            </div>
        </div>
    </div>
</div>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    // Tour Booking Bar Chart
    var tourOptions = {
        series: [{
            name: 'Kişi Sayısı',
            data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(tourCounts))
        }],
        chart: {
            type: 'bar',
            height: 280
        },
        plotOptions: {
            bar: {
                horizontal: true,
                borderRadius: 4
            }
        },
        colors: ['#5D87FF'],
        xaxis: {
            categories: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(tourNames))
        }
    };
    var tourChart = new ApexCharts(document.querySelector("#tourBookingChart"), tourOptions);
    tourChart.render();

    // Monthly Line Chart
    var monthlyOptions = {
        series: [{
            name: 'Rezervasyon',
            data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(monthlyCounts))
        }],
        chart: {
            type: 'area',
            height: 280
        },
        colors: ['#49BEFF'],
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.3
            }
        },
        stroke: {
            curve: 'smooth',
            width: 2
        },
        xaxis: {
            categories: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(monthlyLabels))
        }
    };
    var monthlyChart = new ApexCharts(document.querySelector("#monthlyChart"), monthlyOptions);
    monthlyChart.render();

    // Status Pie Chart
    var statusOptions = {
        series: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(statusCounts)),
        chart: {
            type: 'donut',
            height: 280
        },
        labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(statusLabels.Select(s => s == "Pending" ? "Beklemede" : s == "Confirmed" ? "Onaylandı" : s == "Cancelled" ? "İptal" : s))),
        colors: ['#FFAE1F', '#13DEB9', '#FA896B'],
        legend: {
            position: 'bottom'
        }
    };
    var statusChart = new ApexCharts(document.querySelector("#statusChart"), statusOptions);
    statusChart.render();
</script>
